#!/usr/bin/env python3
#
# Copyright (c) 2023 LateGenXer
#
# SPDX-License-Identifier: AGPL-3.0-or-later
#


from datetime import date

import pytest
from pytest import approx

from xirr import *


def test_xnpv():
    # https://support.microsoft.com/en-us/office/xnpv-function-1b42bbf6-370f-4532-a0eb-d67c16b664b7
    transactions = [
        (-10000, date(2008,  1,  1)),
        (  2750, date(2008,  3,  1)),
        (  4250, date(2008, 10, 30)),
        (  3250, date(2009,  2, 15)),
        (  2750, date(2009,  4,  1)),
    ]

    values, dates = zip(*transactions)
    npv = xnpv(.09, values, dates)
    assert npv == approx(2086.65, abs=1e-02)


def test_xirr():
    # https://support.microsoft.com/en-us/office/xirr-function-de1242ec-6477-445b-b11b-a303ad9adc9d
    transactions = [
        (-10000, date(2008,  1,  1)),
        (  2750, date(2008,  3,  1)),
        (  4250, date(2008, 10, 30)),
        (  3250, date(2009,  2, 15)),
        (  2750, date(2009,  4,  1)),
    ]

    values, dates = zip(*transactions)
    irr = xirr(values, dates, 0.1)
    assert irr == approx(0.373362535, abs=5e-09)


def test_secant():
    # These will trigger a RunTimeError if the secant estimate for derivatives is used
    transactions = [
        (date(2023,  11,  27), -99.87456645714286),
        (date(2024,  5,   22),   0.091727),
        (date(2024,  11,  22),   0.093082),
        (date(2025,  5,   22),   0.094485),
        (date(2025,  11,  22),   0.095875),
        (date(2026,  5,   22),   0.097319),
        (date(2026,  11,  22),   0.098751),
        (date(2027,  5,   22),   0.100239),
        (date(2027,  11,  22),   0.101713),
        (date(2028,  5,   22),   0.103240),
        (date(2028,  11,  22),   0.104765),
        (date(2029,  5,   22),   0.106344),
        (date(2029,  11,  22),   0.107908),
        (date(2030,  5,   22),   0.109534),
        (date(2030,  11,  22),   0.111145),
        (date(2031,  5,   22),   0.112820),
        (date(2031,  11,  22),   0.114479),
        (date(2032,  5,   22),   0.116197),
        (date(2032,  11,  22),   0.117914),
        (date(2033,  5,   22),   0.119691),
        (date(2033,  11,  22),   0.121451),
        (date(2034,  5,   22),   0.123281),
        (date(2034,  11,  22),   0.125095),
        (date(2035,  5,   22),   0.126980),
        (date(2035,  11,  22),   0.128847),
        (date(2036,  5,   22),   0.130781),
        (date(2036,  11,  22),   0.132713),
        (date(2037,  5,   22),   0.134713),
        (date(2037,  11,  22),   0.136694),
        (date(2038,  5,   22),   0.138754),
        (date(2038,  11,  22),   0.140795),
        (date(2039,  5,   22),   0.142917),
        (date(2039,  11,  22),   0.145019),
        (date(2040,  5,   22),   0.147195),
        (date(2040,  11,  22),   0.149369),
        (date(2041,  5,   22),   0.151621),
        (date(2041,  11,  22),   0.153851),
        (date(2042,  5,   22),   0.156169),
        (date(2042,  11,  22),   0.158466),
        (date(2043,  5,   22),   0.160854),
        (date(2043,  11,  22),   0.163220),
        (date(2044,  5,   22),   0.165669),
        (date(2044,  11,  22),   0.168117),
        (date(2045,  5,   22),   0.170650),
        (date(2045,  11,  22),   0.173160),
        (date(2046,  5,   22),   0.175770),
        (date(2046,  11,  22),   0.178355),
        (date(2047,  5,   22),   0.181043),
        (date(2047,  11,  22),   0.183706),
        (date(2048,  5,   22),   0.186462),
        (date(2048,  11,  22),   0.189217),
        (date(2049,  5,   22),   0.192068),
        (date(2049,  11,  22),   0.194893),
        (date(2050,  5,   22),   0.19783),
        (date(2050,  11,  22),   0.20074),
        (date(2051,  5,   22),   0.203765),
        (date(2051,  11,  22),   0.206762),
        (date(2052,  5,   22),   0.209865),
        (date(2052,  11,  22),   0.212965),
        (date(2053,  5,   22),   0.216175),
        (date(2053,  11,  22),   0.219354),
        (date(2054,  5,   22),   0.222660),
        (date(2054,  11,  22),   0.225935),
        (date(2055,  5,   22),   0.229340),
        (date(2055,  11,  22),   0.232713),
        (date(2056,  5,   22),   0.236205),
        (date(2056,  11,  22),   0.239694),
        (date(2057,  5,   22),   0.243306),
        (date(2057,  11,  22),   0.246885),
        (date(2058,  5,   22),   0.250606),
        (date(2058,  11,  22),   0.254291),
        (date(2059,  5,   22),   0.258124),
        (date(2059,  11,  22),   0.261920),
        (date(2060,  5,   22),   0.265851),
        (date(2060,  11,  22),   0.269778),
        (date(2061,  5,   22),   0.273844),
        (date(2061,  11,  22),   0.277871),
        (date(2062,  5,   22),   0.282059),
        (date(2062,  11,  22),   0.286207),
        (date(2063,  5,   22),   0.290521),
        (date(2063,  11,  22),   0.294794),
        (date(2064,  5,   22),   0.299217),
        (date(2064,  11,  22),   0.303637),
        (date(2065,  5,   22),   0.308213),
        (date(2065,  11,  22),   0.312746),
        (date(2065,  11,  22), 500.394287)
    ]

    dates, values = zip(*transactions)

    with pytest.raises(RuntimeError):
        irr = xirr(values, dates, 0.1, secant=True)

    irr = xirr(values, dates, 0.1)
    assert irr == approx(0.0406706, rel=1e-06)
